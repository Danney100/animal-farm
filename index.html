<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Animal Farm</title>
    <!-- Compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.3/axios.min.js"></script>

    <style>
      html {
        width: 100%;
      }
      body {
        width: 100%;
      }
      #location {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
        border-radius: 4px;
      }

      #location td,
      #location th {
        border: 1px solid #ddd;
        padding: 8px;
      }
      .tHead tr > td {
        font-weight: 900;
        font-size: 15px;
      }

      #location tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      #location th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #04aa6d;
        color: white;
      }
      .searchbar {
        margin-top: 24px;
        width: 50%;
      }
      @media (max-width: 768px) {
        .searchbar {
          width: 80%;
        }
      }
      @media (max-width: 450px) {
        .searchbar {
          width: 100%;
        }
      }
      #load-data,
      #nData {
        display: none;
        border: 1px solid #d1cbcb;
        padding-top: 90px;
        height: 200px;
        opacity: 0.8;
        font-weight: 500;
        width: 100%;
        text-align: center;
        margin-top: 20px;
        font-size: 16px;
      }
    </style>
  </head>
  <body style="padding: 0px 25px">
    <div class="row searchbar">
      <div class="col s12">
        <div class="row">
          <div class="input-field row">
            <input
              type="text"
              id="autocomplete-input"
              class="autocomplete col s8"
              onkeyup="valueChange(this)"
            />
            <label for="autocomplete-input">Enter city name...</label>
            <a
              id="search-btn"
              class="waves-effect waves-light btn col s3 offset-s1"
              onclick="handleClick(this)"
              >Search</a
            >
          </div>
        </div>
      </div>
    </div>
    <table id="location" style="width: 100%"></table>
    <div id="nData">No data available</div>
    <div id="load-data">Loading...</div>

    <script type="text/javascript">
      let locations = null;
      let locationsDict = {};
      var elems = document.querySelectorAll(".autocomplete");

      document.addEventListener("DOMContentLoaded", function () {
        var instances = M.Autocomplete.init(elems, {
          onAutocomplete: function (d) {
            const selectedLocation = locations.find(
              (l) => l.name.toLowerCase() === d.toLowerCase()
            );
            let loading = document.getElementById("load-data");
            loading.style.display = "block";
            setTimeout(
              () => handleForecastData(selectedLocation, loading),
              1000
            );
          },
        });
      });

      function valueChange(elem) {
        var instance = M.Autocomplete.getInstance(elem);
        let btn = document.getElementById("search-btn");
        btn.style.opacity = "0.5";
        btn.style.pointerEvents = "none";
        axios
          .post(
            `https://fnw-us.foreca.com/api/v1/location/search/${elem.value}`,
            null,
            {
              headers: {
                Authorization: `Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9mbnctdXMuZm9yZWNhLmNvbVwvYXV0aG9yaXplXC90b2tlbiIsImlhdCI6MTY3Njg4NzgzOCwiZXhwIjoxNjc3NDkyNjM4LCJuYmYiOjE2NzY4ODc4MzgsImp0aSI6IjMyMTc4OWM3ODdiOWUwNWUiLCJzdWIiOiJvY3RuZTc5MzUiLCJmbXQiOiJYRGNPaGpDNDArQUxqbFlUdGpiT2lBPT0ifQ.Ggo2rwGFVM61_2ZKOczfcw7C9WOW4nzrfYL39D5T460`,
              },
            }
          )
          .then(function (response) {
            btn.style.opacity = "1";
            btn.style.pointerEvents = "auto";
            locations = response.data.locations;
            if (locations?.length) {
              response.data.locations.map((r) => {
                locationsDict[r.name] = null;
              });
            }
          })
          .catch(function (error) {
            btn.style.opacity = "1";
            btn.style.pointerEvents = "auto";
            alert(error.response.data.message);
          });
      }
      function handleClick(elem) {
        var instance = M.Autocomplete.getInstance(elems[0]);
        let nData = document.getElementById("nData");
        if (Object.keys(locationsDict)?.length > 0) {
          instance.updateData(locationsDict);
          nData.style.display = "none";
        } else {
          nData.style.display = "block";
          instance.updateData({});
        }

        instance.open();
      }

      function handleForecastData(selectedLocation, loading) {
        axios
          .post(
            `https://fnw-us.foreca.com/api/v1/forecast/daily/${selectedLocation?.id}`,
            null,
            {
              headers: {
                Authorization: `Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9mbnctdXMuZm9yZWNhLmNvbVwvYXV0aG9yaXplXC90b2tlbiIsImlhdCI6MTY3Njg4NzgzOCwiZXhwIjoxNjc3NDkyNjM4LCJuYmYiOjE2NzY4ODc4MzgsImp0aSI6IjMyMTc4OWM3ODdiOWUwNWUiLCJzdWIiOiJvY3RuZTc5MzUiLCJmbXQiOiJYRGNPaGpDNDArQUxqbFlUdGpiT2lBPT0ifQ.Ggo2rwGFVM61_2ZKOczfcw7C9WOW4nzrfYL39D5T460`,
              },
            }
          )
          .then(function (response) {
            loading.style.display = "none";
            const forecast = response.data.forecast;

            if (forecast?.length) {
              var tabl = document.getElementById("location");
              tabl.innerHTML = "";
              var tHead = document.createElement("thead");
              var tBody = document.createElement("tbody");
              tHead.classList.add("tHead");
              tBody.classList.add("tBody");

              tabl.setAttribute("border", "1px solid");
              tabl.appendChild(tHead);
              tabl.appendChild(tBody);

              var fieldTitles = [
                "Day of the week",
                "Date",
                "Max Temprature",
                "Min Temprature",
                "Weather Code",
                "Wind speed and direction",
              ];

              var tHeadRow = document.createElement("tr");
              tHead.appendChild(tHeadRow);

              fieldTitles.forEach(function (field) {
                var tCol = document.createElement("td");
                tCol.innerHTML = field;
                tHeadRow.appendChild(tCol);
              });

              var fields = [
                "day",
                "date",
                "maxTemp",
                "minTemp",
                "symbol",
                "maxWindSpeed",
              ];

              for (var i = 0; i < forecast.length; i++) {
                var tRow = document.createElement("tr");
                tabl.appendChild(tRow);

                fields.forEach(function (field) {
                  var tCol = document.createElement("td");
                  tCol.innerHTML = forecast[i][field];
                  if (field === "day") {
                    var days = [
                      "Sunday",
                      "Monday",
                      "Tuesday",
                      "Wednesday",
                      "Thursday",
                      "Friday",
                      "Saturday",
                    ];
                    const day = new Date(forecast[i]["date"]);
                    tCol.innerHTML = days[day.getDay()];
                  }
                  if (field === "maxTemp" || field === "minTemp") {
                    tCol.innerHTML = `${forecast[i][field]} Â°C`;
                  }
                  if (field === "maxWindSpeed") {
                    tCol.innerHTML = `speed:${forecast[i][field]}    direction:${forecast[i]["windDir"]} `;
                  }
                  tRow.appendChild(tCol);
                });
              }
            }
          })
          .catch((error) => {
            loading.style.display = "none";
            alert(error.response.data.message);
          });
      }
    </script>
  </body>
</html>
